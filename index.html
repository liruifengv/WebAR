<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>调用摄像头拍照 </title>
    <style>
        #videoBox{
            position: absolute;
            left: 50%;
            top: 50%;
            z-index: 1;
            -webkit-transform: translate(-50%,-50%);
            -webkit-transform-origin: 50% 50%;
            background: #ff0000
        };
        #videoWrap{position: relative;left: 0;top: 0;background: #4CAABE;overflow: hidden;}
        canvas {
            position: absolute;
            left: 0;
            top: 0;
            z-index: 1000;
        }
         .rect {
    position: absolute;
  }
    </style>
</head>
<body>
    <div id="videoWrap">
        <video autoplay="autoplay" id="videoBox"></video>
    </div>
    <script src="./three/three.js"></script>
    <script src="./build/tracking.js"></script>
    <script src="./vconsole.min.js"></script>
<script>
    var vConsole = new VConsole();
    console.log('vConsole INIT')
    try {　　
        // 此处是可能产生例外的语句
            var videoWrap = document.getElementById('videoWrap');
    let video = document.getElementById('videoBox')

    videoWrap.style.width = window.innerWidth + 'px';
    videoWrap.style.height = window.innerHeight + 'px';
   video.style.width = window.innerWidth + 'px';
    video.style.height = window.innerHeight + 'px';
    var vwidth = window.innerWidth;
    var vheight = window.innerHeight;
  function getUserMedia(constrains,success,error) {
    if (navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia(constrains).then(success).catch(error)
    } else if (navigator.webkitGetUserMedia) {
      navigator.webkitGetUserMedia(constrains,success.error)
    } else if (navigator.mozGetUserMedia) {
      navigator.mozkitGetUserMedia(constrains,success.error)
    } else if (navigator.getUserMedia) {
      navigator.getUserMedia(constrains,success,error)
    }
  }
  function success(stream) {
    if(!stream) {
        alert('stream:',stream)
    }
    let CompatibleUrl = window.URL || window.webkitURL
    video.src = CompatibleUrl.createObjectURL(stream)
    video.play()
  }
  function error(error) {
    alert('ERROR:',error.name,error.message)
  }
  
  if (navigator.mediaDevices.getUserMedia || navigator.getUserMedia || navigator.mozGetUserMedia || navigator.webkitGetUserMedia) {
      try {　　
          // 此处是可能产生例外的语句
        getUserMedia({video:{ facingMode: { exact: "environment" }}},success,error)
        } catch (error) {　　
          // 此处是负责例外处理的语句
          alert(error);　　
        } finally {　　
          // 此处是出口语句
          console.log("执行完毕");
        }
  } else {
    alert('you bower id not getUserMedia')
  }
      } catch (error) {　　
        // 此处是负责例外处理的语句
        alert(error);　　
      } finally {　　
        // 此处是出口语句
      }


   // 先注册颜色
    tracking.ColorTracker.registerColor('red', function(r, g, b) {
      if (r > 120 && g < 100 && b < 100) {
        return true;
      }
      return false;
    });

      var colors = new tracking.ColorTracker(['red']);

         colors.on('track', function(event){
            if (event.data.length === 0)
            {
                // No colors were detected in this frame.
            }
            else
            {
                event.data.forEach(function(rect)
                {
                //如果rect不是undefined 代表有东西,则代表有框框,则可以删除
                    if(rect != undefined) {
                        var elements = document.getElementsByClassName('rect');
                        while(elements.length > 0)
                        {
                        elements[0].parentNode.removeChild(elements[0]);
                        }
                    }
                    console.log("■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■");
                    console.log(rect.x, rect.y, rect.width, rect.height, rect.color);
                    console.log("■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■");
                    window.plot(rect.x, rect.y, rect.width, rect.height, rect.color);
                });
            }
            });

   window.plot = function(x, y, w, h, color)
    {
      rect = document.createElement('div');
      document.querySelector('body').appendChild(rect);
      rect.classList.add('rect');
      rect.style.border = '2px solid #108ee9';
      rect.style.width = w + 'px';
      rect.style.height = h + 'px';
    let video = document.getElementById('videoBox')
      rect.style.left = (video.offsetLeft + x) + 'px';
      rect.style.top = (video.offsetTop + y) + 'px';
      rect.style.zIndex = 1001;
    };

    tracking.track('#videoBox', colors);


    function init3D() { 
 		var camera, scene, renderer;
        var mesh;
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 );

        var renderer = new THREE.WebGLRenderer( { alpha: true } );
        renderer.setSize( window.innerWidth, window.innerHeight );
        renderer.setClearColor( 0x000000, 0 ); // the default
        document.body.appendChild( renderer.domElement );

        var geometry = new THREE.BoxGeometry( 1, 1, 1 );
        var material = new THREE.MeshBasicMaterial( { color: 0xff0000 } );
        var cube = new THREE.Mesh( geometry, material );
        scene.add( cube );

        camera.position.z = 5;

        var animate = function () {
            requestAnimationFrame( animate );

            cube.rotation.x += 0.01;
            cube.rotation.y += 0.01;

            renderer.render( scene, camera );
        };

        animate();
    }
    


</script>
</body>
</html>